<div class="nested-fields">
  <% skus_by_category = Warehouse::SKU.in_inventory.order(:sku).group_by(&:category) %>

  <%= f.grouped_collection_select :sku_id,
                                   skus_by_category,
                                   :last, # gets the array of products
                                   lambda { |group| group.first.humanize }, # humanized category name
                                   :id,
                                   -> (sku) { "#{sku.sku} - #{sku.name} (#{sku.in_stock} in stock)"},
                                   { include_blank: 'pick a SKU!' },
                                   { class: 'needs-select2', disabled: f.object.persisted? } %>
  
  <% if f.object.persisted? %>
    <%= f.hidden_field :sku_id %> <!-- Keep the original value when submitting -->
  <% end %>
  
  <%= f.number_field :quantity %>
  <%= link_to_remove_association "remove", f %>
</div>